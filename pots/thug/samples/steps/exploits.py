import sys
import os
from behave import *
from behave.log_capture import capture

THUG     = os.path.dirname(os.path.abspath(__file__)).split("samples")[0]
EXPLOITS = os.path.join(THUG, 'samples', 'exploits')
sys.path.append(os.path.join(THUG, 'src'))

from ThugAPI import ThugAPI

class Exploits(object):
    def __init__(self, context):
        self.exploits = list()
        for row in context.table:
            self.exploits.append(row)

    def _run(self, context, exploit):
        sample = os.path.join(EXPLOITS, exploit[0])

        instance = ThugAPI(None, None)
        instance.set_events('click')
        instance.set_timeout(1)
        instance.log_init(sample)
        instance.run_local(sample)

        for assertion in exploit[1].split(","):
            assert assertion in context.log_capture.getvalue()

    def run(self, context):
        for exploit in self.exploits:
            self._run(context, exploit)

@given('set of exploits')
def step_impl(context):
    global exploits 
    exploits = Exploits(context)

@capture
@then('run exploit')
def step_impl(context):
    exploits.run(context)
